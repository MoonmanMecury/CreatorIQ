# Production Upgrade Checklist: Alerts & Notifications System

This document outlines the necessary steps to move the Alerts & Notifications system from its current in-memory MVP state to a production-ready, scalable architecture.

## 1. Database Persistence (PostgreSQL / Supabase)
Currently, all alerts and user preferences are stored in-memory, which means they are lost on server restart and not shared across sessions.

- [ ] **Alerts Table**: 
  - Create an `alerts` table with columns: `id`, `user_id`, `type`, `severity`, `status`, `niche_id`, `keyword`, `title`, `description`, `recommended_action`, `metric_changed`, `previous_value`, `current_value`, `change_delta`, `change_percent`, `created_at`, `read_at`, `related_url`.
  - Add indexes on `user_id` and `created_at`.
- [ ] **Alert Preferences Table**:
  - Create a `user_alert_settings` table to store `enabled_alert_types` (jsonb/array), `minimum_severity`, `notification_frequency`, `email_enabled`, and `in_app_enabled`.
- [ ] **Thresholds Table**:
  - Store `alert_thresholds` as a related table or a JSONB column within preferences.
- [ ] **Per-Niche Overrides**:
  - Create a `niche_alert_settings` table to handle specific overrides for individual keywords.

## 2. Background Processing (Market Pulse)
Alerts are currently triggered by UI interaction or polling. Production requires a decoupled processing layer.

- [ ] **Cron Jobs**:
  - Implement a daily/6-hour cron job (e.g., Vercel Cron or GitHub Actions) that iterates through all `saved_niches` for all users.
  - Call the `processAlerts` service for each user to generate notifications even when the user is offline.
- [ ] **Metric Snapshots**:
  - Ensure the system takes a "snapshot" of niche metrics every time the background job runs to provide the `previousSnapshots` data needed for comparison.

## 3. Real-time Delivery (WebSockets / SSE)
Currently, the UI polls every 60 seconds (`useAlerts` hook).

- [ ] **Supabase Realtime**:
  - Enable Realtime on the `alerts` table.
  - Update `useAlerts.ts` to subscribe to the `INSERT` channel for the current `userId`.
  - This allows the notification bell to jingle the exact millisecond an alert is generated by the background worker.

## 4. External Notifications (Email / SMS)
The current system uses a stub (`emailNotifier.ts`).

- [ ] **Email Provider Integration**:
  - Replace the stub in `emailNotifier.ts` with a real provider (e.g., **Resend**, **SendGrid**, or **Postmark**).
  - Use a library like `react-email` to build premium, responsive email layouts for both "Instant" alerts and "Digest" summaries.
- [ ] **Notification Queue Persistence**:
  - Move the `NotificationQueue` to **Redis** (via BullMQ or Upstash) to handle retries and scheduled delivery for Daily/Weekly digests.

## 5. Security & Multi-tenancy
- [ ] **Auth Integration**:
  - Replace the `'demo-user'` hardcoded ID in API routes with the actual session user ID retrieved from `supabase.auth.getUser()`.
  - Implement Row Level Security (RLS) on all alert tables to ensure users can only see their own notifications.
